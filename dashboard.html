<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - UrbanGrow</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <header>
        <div class="header-left">
            <a href="index.html" class="nav-button">üè† Home</a>
            <div class="logo">üåø UrbanGrow</div>
        </div>
        <div class="header-center">
            <input type="text" id="search-bar" placeholder="Search for plants..." />
            <button id="camera-btn" class="nav-button">üì∑</button>
        </div>
        <div class="header-right" id="header-right">
            <!-- Dynamic: Dashboard and Account -->
        </div>
    </header>
    <main>
        <section id="dashboard">
            <div class="dashboard-header">
                <div class="welcome-message">
                    <h1>Welcome back, <span id="user-name-display">Gardener</span>! üåø</h1>
                    <p>Here's what's happening in your garden today</p>
                </div>
                <div class="current-date" id="current-date"></div>
            </div>

            <!-- Stats Overview -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-icon">üå±</div>
                    <div class="stat-content">
                        <h3>Total Plants</h3>
                        <p class="stat-number" id="total-plants">0</p>
                        <span class="stat-change positive" id="plants-change"></span>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">üíß</div>
                    <div class="stat-content">
                        <h3>Tasks Today</h3>
                        <p class="stat-number" id="tasks-today">0</p>
                        <span class="stat-change" id="tasks-status"></span>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">‚úÖ</div>
                    <div class="stat-content">
                        <h3>Healthy Plants</h3>
                        <p class="stat-number" id="healthy-plants">0</p>
                        <span class="stat-change positive" id="health-rate"></span>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">‚ö†Ô∏è</div>
                    <div class="stat-content">
                        <h3>Need Attention</h3>
                        <p class="stat-number" id="attention-plants">0</p>
                        <span class="stat-change warning" id="attention-status"></span>
                    </div>
                </div>
            </div>

            <!-- Recent Activity & Upcoming Tasks -->
            <div class="dashboard-sections">
                <div class="activity-section">
                    <div class="section-header">
                        <h2>üìã Upcoming Tasks</h2>
                        <a href="reminders.html" class="view-all">View All ‚Üí</a>
                    </div>
                    <div class="task-list" id="task-list">
                        <!-- Tasks will be loaded dynamically -->
                    </div>
                </div>

                <div class="activity-section">
                    <div class="section-header">
                        <h2>üå± My Garden</h2>
                        <a href="my-garden.html" class="view-all">View All ‚Üí</a>
                    </div>
                    <div class="plant-grid">
                        <div class="plant-mini-card">
                            <img src="snakeplant.webp" alt="Snake Plant" onerror="this.src='default.jpg'">
                            <div class="plant-info">
                                <h4>Snake Plant</h4>
                                <span class="health-badge healthy">Healthy</span>
                            </div>
                        </div>
                        <div class="plant-mini-card">
                            <img src="cherrytomato.webp" alt="Cherry Tomato" onerror="this.src='default.jpg'">
                            <div class="plant-info">
                                <h4>Cherry Tomato</h4>
                                <span class="health-badge attention">Needs Water</span>
                            </div>
                        </div>
                        <div class="plant-mini-card">
                            <img src="default.jpg" alt="Basil">
                            <div class="plant-info">
                                <h4>Basil</h4>
                                <span class="health-badge healthy">Healthy</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Navigation Cards -->
            <div class="section-title">
                <h2>Manage Your Garden</h2>
            </div>
            <div class="nav-cards">
                <a href="my-garden.html" class="nav-card">
                    <div class="nav-card-icon">üè°</div>
                    <h3>My Garden</h3>
                    <p>View and manage all your plants</p>
                </a>
                <a href="trackrecord.html" class="nav-card">
                    <div class="nav-card-icon">üìä</div>
                    <h3>Track Record</h3>
                    <p>View your gardening activities</p>
                </a>
                <a href="profile.html" class="nav-card">
                    <div class="nav-card-icon">üë§</div>
                    <h3>Profile</h3>
                    <p>Manage your account settings</p>
                </a>
            </div>
        </section>
    </main>
    <script>
        // Auth check
        const currentUser = JSON.parse(localStorage.getItem('currentUser'));
        if (!currentUser) {
            window.location.href = 'login.html';
        } else {
            // Update header for logged in
            const headerRight = document.getElementById('header-right');
            headerRight.innerHTML = `<a href="dashboard.html" class="nav-button">Dashboard</a> <div class="account-dropdown" id="account-name">${currentUser.name} ‚ñº</div><div class="dropdown-menu" id="dropdown-menu" style="display:none; position:absolute; background:white; border:1px solid #ccc; padding:10px; z-index:1000;"><button onclick="logout()">Log Out</button><button onclick="profile()">Profile</button><button onclick="switchUser()">Switch User</button></div>`;
            
            // Display user name in welcome message
            document.getElementById('user-name-display').textContent = currentUser.name;
            
            // Add event listener for dropdown
            document.getElementById('account-name').addEventListener('click', function() {
                const menu = document.getElementById('dropdown-menu');
                menu.style.display = menu.style.display === 'none' ? 'block' : 'none';
            });
        }

        // Display current date
        const dateElement = document.getElementById('current-date');
        const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
        dateElement.textContent = new Date().toLocaleDateString('en-US', options);

        // Load actual plant count from localStorage
        function updatePlantStats() {
            const myGarden = JSON.parse(localStorage.getItem('myGarden')) || [];
            const totalPlantsElement = document.getElementById('total-plants');
            const plantsChangeElement = document.getElementById('plants-change');
            const healthyPlantsElement = document.getElementById('healthy-plants');
            const healthRateElement = document.getElementById('health-rate');
            const attentionPlantsElement = document.getElementById('attention-plants');
            const attentionStatusElement = document.getElementById('attention-status');
            
            // Update total plants count
            totalPlantsElement.textContent = myGarden.length;
            
            // Calculate health statistics
            let healthyCount = 0;
            let needsAttentionCount = 0;
            
            myGarden.forEach(plant => {
                // Check if plant has health status
                if (plant.health === 'healthy' || plant.status === 'healthy') {
                    healthyCount++;
                } else if (plant.health === 'attention' || plant.status === 'attention' || plant.needsAttention) {
                    needsAttentionCount++;
                } else {
                    // If no status is set, consider it healthy by default
                    healthyCount++;
                }
            });
            
            // Update healthy plants
            healthyPlantsElement.textContent = healthyCount;
            
            // Update health rate
            if (myGarden.length === 0) {
                healthRateElement.textContent = 'No plants yet';
                healthRateElement.className = 'stat-change';
            } else {
                const healthRate = Math.round((healthyCount / myGarden.length) * 100);
                healthRateElement.textContent = `${healthRate}% health rate`;
                healthRateElement.className = 'stat-change positive';
            }
            
            // Update plants needing attention
            attentionPlantsElement.textContent = needsAttentionCount;
            
            // Update attention status
            if (needsAttentionCount === 0) {
                attentionStatusElement.textContent = 'All good!';
                attentionStatusElement.className = 'stat-change positive';
            } else {
                attentionStatusElement.textContent = 'Check now';
                attentionStatusElement.className = 'stat-change warning';
            }
            
            // Update change message for total plants
            if (myGarden.length === 0) {
                plantsChangeElement.textContent = 'Add your first plant!';
                plantsChangeElement.className = 'stat-change';
            } else if (myGarden.length === 1) {
                plantsChangeElement.textContent = 'Great start!';
                plantsChangeElement.className = 'stat-change positive';
            } else {
                plantsChangeElement.textContent = `${myGarden.length} plants growing`;
                plantsChangeElement.className = 'stat-change positive';
            }
        }
        
        // Call the function to update stats
        updatePlantStats();

        // Load tasks from localStorage and display today's tasks
        function loadTodaysTasks() {
            const reminders = JSON.parse(localStorage.getItem('reminders')) || [];
            const taskListElement = document.getElementById('task-list');
            const tasksTodayElement = document.getElementById('tasks-today');
            const tasksStatusElement = document.getElementById('tasks-status');
            
            // Get today's date
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            // Filter tasks for today
            const todaysTasks = reminders.filter(reminder => {
                const reminderDate = new Date(reminder.date || reminder.time);
                reminderDate.setHours(0, 0, 0, 0);
                return reminderDate.getTime() === today.getTime();
            });
            
            // Separate pending and completed tasks
            const pendingTasks = todaysTasks.filter(t => t.status !== 'completed');
            const completedTasks = todaysTasks.filter(t => t.status === 'completed');
            
            // Update task count (show pending tasks)
            tasksTodayElement.textContent = pendingTasks.length;
            
            // Update status message
            if (todaysTasks.length === 0) {
                tasksStatusElement.textContent = 'No tasks scheduled';
                tasksStatusElement.className = 'stat-change';
            } else if (completedTasks.length === todaysTasks.length) {
                tasksStatusElement.textContent = 'All tasks completed!';
                tasksStatusElement.className = 'stat-change positive';
            } else {
                tasksStatusElement.textContent = `${completedTasks.length}/${todaysTasks.length} completed`;
                tasksStatusElement.className = 'stat-change';
            }
            
            // Clear task list
            taskListElement.innerHTML = '';
            
            // Display tasks or empty message
            if (todaysTasks.length === 0) {
                taskListElement.innerHTML = `
                    <div style="text-align: center; padding: 30px; color: #999;">
                        <p>No tasks scheduled for today</p>
                        <a href="reminders.html" style="color: #4CAF50; text-decoration: none;">Set a reminder ‚Üí</a>
                    </div>
                `;
            } else {
                // Display pending tasks first
                if (pendingTasks.length > 0) {
                    pendingTasks.forEach(task => {
                        const taskIcon = getTaskIcon(task.task || task.type);
                        const taskItem = document.createElement('div');
                        taskItem.className = 'task-item';
                        taskItem.setAttribute('data-task-id', task.id);
                        taskItem.innerHTML = `
                            <div class="task-icon">${taskIcon}</div>
                            <div class="task-details">
                                <h4>${task.task || task.type} ${task.plantName || task.plant || ''}</h4>
                                <p>Due ${task.time || 'today'}</p>
                            </div>
                            <button class="task-complete" onclick="completeTaskDashboard(${task.id})">‚úì</button>
                        `;
                        taskListElement.appendChild(taskItem);
                    });
                }
                
                // Display completed tasks
                if (completedTasks.length > 0) {
                    const completedHeader = document.createElement('div');
                    completedHeader.style.cssText = 'margin-top: 20px; padding-top: 20px; border-top: 1px solid #e0e0e0;';
                    completedHeader.innerHTML = '<h4 style="color: #4CAF50; margin-bottom: 10px;">‚úì Completed Today</h4>';
                    taskListElement.appendChild(completedHeader);
                    
                    completedTasks.forEach(task => {
                        const taskIcon = getTaskIcon(task.task || task.type);
                        const taskItem = document.createElement('div');
                        taskItem.className = 'task-item';
                        taskItem.style.opacity = '0.6';
                        taskItem.innerHTML = `
                            <div class="task-icon">${taskIcon}</div>
                            <div class="task-details">
                                <h4 style="text-decoration: line-through;">${task.task || task.type} ${task.plantName || task.plant || ''}</h4>
                                <p>Completed at ${new Date(task.completedAt).toLocaleTimeString()}</p>
                            </div>
                            <div style="color: #4CAF50; font-size: 24px;">‚úì</div>
                        `;
                        taskListElement.appendChild(taskItem);
                    });
                }
            }
        }
        
        // Get appropriate icon for task type
        function getTaskIcon(taskType) {
            const icons = {
                'Water': 'üíß',
                'Fertilize': 'üåø',
                'Pesticide': 'üêõ',
                'Cutting': '‚úÇÔ∏è',
                'Prune': '‚úÇÔ∏è',
                'default': 'üìã'
            };
            return icons[taskType] || icons['default'];
        }
        
        // Complete task function from dashboard
        function completeTaskDashboard(taskId) {
            let reminders = JSON.parse(localStorage.getItem('reminders')) || [];
            const reminderIndex = reminders.findIndex(r => r.id === taskId);
            
            if (reminderIndex !== -1) {
                reminders[reminderIndex].status = 'completed';
                reminders[reminderIndex].completedAt = new Date().toISOString();
                localStorage.setItem('reminders', JSON.stringify(reminders));
                
                // Add to task history
                let taskHistory = JSON.parse(localStorage.getItem('taskHistory')) || [];
                taskHistory.unshift({
                    ...reminders[reminderIndex],
                    completedAt: new Date().toISOString()
                });
                localStorage.setItem('taskHistory', JSON.stringify(taskHistory));
                
                // Reload tasks to show updated status
                loadTodaysTasks();
            }
        }
        
        // Load tasks on page load
        loadTodaysTasks();

        function logout() {
            localStorage.removeItem('currentUser');
            window.location.href = 'login.html';
        }

        function profile() {
            window.location.href = 'profile.html';
        }

        function switchUser() {
            logout();
        }
    </script>
    <script src="script.js"></script>
</body>
</html>
